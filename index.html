<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .dark {
            --bg-primary: #1f1f1f;
            --bg-secondary: #282828;
            --bg-tertiary: #2f2f2f;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --user-msg-bg: #2f3338;
            --ai-msg-bg: transparent;
        }

        .light {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f4;
            --text-primary: #1f1f1f;
            --text-secondary: #5f6368;
            --border-color: #e8eaed;
            --user-msg-bg: #e3f2fd;
            --ai-msg-bg: transparent;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            z-index: 9999;
        }

        .sidebar {
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
        }

        .chat-item {
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background-color: var(--bg-tertiary);
        }

        .chat-item.active {
            background-color: var(--bg-tertiary);
        }

        .message {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-cursor::after {
            content: '▋';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        pre code {
            display: block;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                height: 100%;
                width: 280px;
                z-index: 50;
                transition: left 0.3s ease;
            }

            .sidebar.active {
                left: 0;
            }
        }

        .input-container {
            background-color: var(--bg-primary);
            border-top: 1px solid var(--border-color);
        }

        textarea:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .image-preview {
            position: relative;
            display: inline-block;
        }

        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .message-image {
            max-width: 300px;
            border-radius: 8px;
            margin-top: 8px;
        }

        /* Prevent scroll jumping */
        .messages-locked {
            overflow: hidden !important;
        }
    </style>
</head>
<body class="light">
    <div id="loading">Loading App...</div>

    <div id="app" style="display: none;" class="min-h-screen flex flex-col">
        <!-- Mobile Header -->
        <div class="md:hidden flex items-center p-3 border-b" style="border-color: var(--border-color); background-color: var(--bg-secondary);">
            <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-opacity-10 hover:bg-black">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <h1 class="ml-3 text-lg font-semibold">AI Chat</h1>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar Overlay (Mobile) -->
            <div id="sidebarOverlay" class="sidebar-overlay"></div>

            <!-- Sidebar -->
            <div id="sidebar" class="sidebar w-64 md:w-72 flex flex-col">
                <div class="p-4 border-b" style="border-color: var(--border-color);">
                    <button id="newChatBtn" class="w-full py-3 px-4 rounded-lg font-medium transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        + New Chat
                    </button>
                </div>
                
                <div id="chatList" class="flex-1 overflow-y-auto p-2"></div>

                <div class="p-3 border-t" style="border-color: var(--border-color);">
                    <button id="settingsBtn" class="w-full py-2 px-3 rounded-lg text-left flex items-center gap-2 hover:bg-opacity-10 hover:bg-black">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Settings
                    </button>
                    <button id="darkModeToggle" class="w-full py-2 px-3 rounded-lg text-left flex items-center gap-2 hover:bg-opacity-10 hover:bg-black mt-2">
                        <svg id="darkModeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                        </svg>
                        <span id="darkModeText">Dark Mode</span>
                    </button>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="flex-1 flex flex-col">
                <!-- Messages -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-6">
                    <div id="messages" class="max-w-4xl mx-auto"></div>
                </div>

                <!-- Input Area -->
                <div class="input-container p-4">
                    <div class="max-w-4xl mx-auto">
                        <!-- Image Preview Area -->
                        <div id="imagePreviewContainer" class="mb-2 flex gap-2 flex-wrap" style="display: none;"></div>
                        
                        <div class="flex gap-2 items-end">
                            <!-- Image Upload Button -->
                            <label for="imageUpload" class="p-3 rounded-lg cursor-pointer transition hover:bg-opacity-10 hover:bg-black" style="background-color: var(--bg-secondary);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                            </label>
                            
                            <textarea 
                                id="messageInput" 
                                rows="1"
                                placeholder="Message AI..."
                                class="flex-1 p-3 rounded-lg resize-none"
                                style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); max-height: 200px;"
                            ></textarea>
                            <button 
                                id="sendBtn"
                                class="p-3 rounded-lg transition"
                                style="background-color: #1a73e8; color: white;"
                            >
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal items-center justify-center">
            <div class="rounded-lg shadow-xl w-full max-w-md mx-4" style="background-color: var(--bg-primary);">
                <div class="p-6 border-b" style="border-color: var(--border-color);">
                    <h2 class="text-xl font-semibold">Settings</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block mb-2 font-medium">OpenRouter API Key</label>
                        <input 
                            type="password" 
                            id="apiKeyInput" 
                            placeholder="sk-or-v1-..."
                            class="w-full p-3 rounded-lg"
                            style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
                        >
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Model</label>
                        <input 
                            type="text" 
                            id="modelInput" 
                            placeholder="arcee-ai/trinity-large-preview:free"
                            class="w-full p-3 rounded-lg"
                            style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
                        >
                        <p class="text-xs mt-1" style="color: var(--text-secondary);">For vision: google/gemini-2.0-flash-exp:free</p>
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">System Prompt</label>
                        <textarea 
                            id="systemPromptInput" 
                            rows="3"
                            placeholder="You are a helpful assistant..."
                            class="w-full p-3 rounded-lg resize-none"
                            style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
                        ></textarea>
                    </div>
                </div>
                <div class="p-6 border-t flex gap-3" style="border-color: var(--border-color);">
                    <button id="saveSettingsBtn" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: #1a73e8; color: white;">
                        Save
                    </button>
                    <button id="cancelSettingsBtn" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Rename Modal -->
        <div id="renameModal" class="modal items-center justify-center">
            <div class="rounded-lg shadow-xl w-full max-w-md mx-4" style="background-color: var(--bg-primary);">
                <div class="p-6 border-b" style="border-color: var(--border-color);">
                    <h2 class="text-xl font-semibold">Rename Chat</h2>
                </div>
                <div class="p-6">
                    <input 
                        type="text" 
                        id="renameInput" 
                        placeholder="Chat name..."
                        class="w-full p-3 rounded-lg"
                        style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);"
                    >
                </div>
                <div class="p-6 border-t flex gap-3" style="border-color: var(--border-color);">
                    <button id="saveRenameBtn" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: #1a73e8; color: white;">
                        Save
                    </button>
                    <button id="cancelRenameBtn" class="flex-1 py-2 px-4 rounded-lg font-medium" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================
        // STATE MANAGEMENT
        // =============================
        const state = {
            chats: [],
            currentChatId: null,
            apiKey: '',
            model: 'arcee-ai/trinity-large-preview:free',
            systemPrompt: 'You are a helpful assistant.',
            darkMode: false,
            renamingChatId: null,
            uploadedImages: [],
            isStreaming: false,
            userIsTyping: false
        };

        // =============================
        // UTILITY FUNCTIONS
        // =============================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('aiChatState', JSON.stringify({
                    chats: state.chats,
                    apiKey: state.apiKey,
                    model: state.model,
                    systemPrompt: state.systemPrompt,
                    darkMode: state.darkMode
                }));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('aiChatState');
                if (saved) {
                    const data = JSON.parse(saved);
                    state.chats = data.chats || [];
                    state.apiKey = data.apiKey || '';
                    state.model = data.model || 'arcee-ai/trinity-large-preview:free';
                    state.systemPrompt = data.systemPrompt || 'You are a helpful assistant.';
                    state.darkMode = data.darkMode || false;
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
            }
        }

        // =============================
        // IMAGE HANDLING
        // =============================
        function handleImageUpload(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imageData = e.target.result;
                        state.uploadedImages.push({
                            id: generateId(),
                            data: imageData,
                            type: file.type
                        });
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeImage(imageId) {
            state.uploadedImages = state.uploadedImages.filter(img => img.id !== imageId);
            renderImagePreviews();
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            if (state.uploadedImages.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = state.uploadedImages.map(img => `
                <div class="image-preview">
                    <img src="${img.data}" alt="Upload preview">
                    <div class="image-preview-remove" onclick="removeImage('${img.id}')">×</div>
                </div>
            `).join('');
        }

        function clearUploadedImages() {
            state.uploadedImages = [];
            renderImagePreviews();
        }

        // =============================
        // CHAT MANAGEMENT
        // =============================
        function createNewChat() {
            const chat = {
                id: generateId(),
                name: 'New Chat',
                messages: [],
                createdAt: Date.now()
            };
            state.chats.unshift(chat);
            state.currentChatId = chat.id;
            saveToLocalStorage();
            renderChatList();
            renderMessages();
            closeMobileSidebar();
        }

        function switchChat(chatId) {
            state.currentChatId = chatId;
            clearUploadedImages();
            renderMessages();
            renderChatList();
            closeMobileSidebar();
        }

        function deleteChat(chatId) {
            if (!confirm('Delete this chat?')) return;
            state.chats = state.chats.filter(c => c.id !== chatId);
            if (state.currentChatId === chatId) {
                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
            }
            saveToLocalStorage();
            renderChatList();
            renderMessages();
        }

        function renameChat(chatId, newName) {
            const chat = state.chats.find(c => c.id === chatId);
            if (chat) {
                chat.name = newName || 'Unnamed Chat';
                saveToLocalStorage();
                renderChatList();
            }
        }

        function getCurrentChat() {
            return state.chats.find(c => c.id === state.currentChatId);
        }

        function autoRenameChat(chatId) {
            const chat = state.chats.find(c => c.id === chatId);
            if (chat && chat.messages.length > 0 && chat.name === 'New Chat') {
                const firstUserMsg = chat.messages.find(m => m.role === 'user');
                if (firstUserMsg) {
                    const textContent = typeof firstUserMsg.content === 'string' 
                        ? firstUserMsg.content 
                        : firstUserMsg.content.find(c => c.type === 'text')?.text || 'Chat';
                    chat.name = textContent.substring(0, 30) + (textContent.length > 30 ? '...' : '');
                    saveToLocalStorage();
                    renderChatList();
                }
            }
        }

        // =============================
        // MESSAGE HANDLING
        // =============================
        async function sendMessage(content) {
            if (!content.trim() && state.uploadedImages.length === 0) return;
            if (!state.apiKey) {
                alert('Please set your OpenRouter API key in Settings');
                return;
            }

            let chat = getCurrentChat();
            if (!chat) {
                createNewChat();
                chat = getCurrentChat();
            }

            // Build message content
            let messageContent;
            if (state.uploadedImages.length > 0) {
                messageContent = [
                    { type: 'text', text: content.trim() || 'What\'s in this image?' },
                    ...state.uploadedImages.map(img => ({
                        type: 'image_url',
                        image_url: { url: img.data }
                    }))
                ];
            } else {
                messageContent = content.trim();
            }

            const userMessage = { 
                role: 'user', 
                content: messageContent,
                images: state.uploadedImages.length > 0 ? [...state.uploadedImages] : null
            };
            
            chat.messages.push(userMessage);
            saveToLocalStorage();
            renderMessages();
            autoRenameChat(chat.id);
            clearUploadedImages();

            const aiMessageId = generateId();
            const aiMessage = { role: 'assistant', content: '', id: aiMessageId, streaming: true };
            chat.messages.push(aiMessage);
            state.isStreaming = true;
            renderMessages();

            try {
                await streamCompletion(chat.messages, aiMessageId);
            } catch (error) {
                aiMessage.content = 'Error: ' + error.message;
                aiMessage.streaming = false;
                state.isStreaming = false;
                saveToLocalStorage();
                renderMessages();
            }
        }

        async function streamCompletion(messages, messageId) {
            const chat = getCurrentChat();
            if (!chat) return;

            const aiMessage = chat.messages.find(m => m.id === messageId);
            if (!aiMessage) return;

            // Convert messages to API format
            const apiMessages = [
                { role: 'system', content: state.systemPrompt },
                ...messages.filter(m => m.role !== 'assistant' || !m.streaming).map(m => {
                    if (m.role === 'user' && m.images) {
                        return {
                            role: 'user',
                            content: m.content
                        };
                    }
                    return {
                        role: m.role,
                        content: typeof m.content === 'string' ? m.content : m.content
                    };
                })
            ];

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + state.apiKey,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'Universal AI Chat'
                },
                body: JSON.stringify({
                    model: state.model,
                    messages: apiMessages,
                    stream: true
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error('API request failed: ' + response.statusText + ' - ' + errorText);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;

                        try {
                            const json = JSON.parse(data);
                            const delta = json.choices && json.choices[0] && json.choices[0].delta;
                            if (delta && delta.content) {
                                aiMessage.content += delta.content;
                                renderMessages();
                                if (!state.userIsTyping) {
                                    scrollToBottom();
                                }
                            }
                        } catch (e) {
                            console.error('Parse error:', e);
                        }
                    }
                }
            }

            aiMessage.streaming = false;
            state.isStreaming = false;
            saveToLocalStorage();
            renderMessages();
        }

        // =============================
        // RENDERING
        // =============================
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            if (!chatList) return;

            if (state.chats.length === 0) {
                chatList.innerHTML = '<div class="p-4 text-center" style="color: var(--text-secondary);">No chats yet</div>';
                return;
            }

            chatList.innerHTML = state.chats.map(chat => {
                const isActive = chat.id === state.currentChatId;
                return `
                    <div class="chat-item p-3 rounded-lg mb-1 flex items-center gap-2 ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                        <div class="flex-1 truncate cursor-pointer" onclick="switchChat('${chat.id}')">
                            ${escapeHtml(chat.name)}
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openRenameModal('${chat.id}')" class="p-1 rounded hover:bg-opacity-10 hover:bg-black" title="Rename">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteChat('${chat.id}')" class="p-1 rounded hover:bg-opacity-10 hover:bg-black" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            if (!messagesDiv) return;

            const chat = getCurrentChat();
            if (!chat || chat.messages.length === 0) {
                messagesDiv.innerHTML = '<div class="text-center py-12" style="color: var(--text-secondary);">Start a conversation</div>';
                return;
            }

            messagesDiv.innerHTML = chat.messages.map(msg => {
                const isUser = msg.role === 'user';
                const alignment = isUser ? 'justify-end' : 'justify-start';
                const bgColor = isUser ? 'var(--user-msg-bg)' : 'var(--ai-msg-bg)';
                
                let textContent = '';
                if (typeof msg.content === 'string') {
                    textContent = msg.content;
                } else if (Array.isArray(msg.content)) {
                    const textPart = msg.content.find(c => c.type === 'text');
                    textContent = textPart ? textPart.text : '';
                }

                let content = textContent;
                if (!msg.streaming) {
                    try {
                        content = marked.parse(content);
                    } catch (e) {
                        content = escapeHtml(content);
                    }
                } else {
                    content = '<span class="typing-cursor">' + escapeHtml(content) + '</span>';
                }

                // Add images if present
                let imageHtml = '';
                if (msg.images && msg.images.length > 0) {
                    imageHtml = msg.images.map(img => 
                        `<img src="${img.data}" class="message-image" alt="Uploaded image">`
                    ).join('');
                }

                return `
                    <div class="message flex ${alignment} mb-4">
                        <div class="max-w-3xl px-4 py-3 rounded-lg" style="background-color: ${bgColor};">
                            ${imageHtml}
                            <div class="prose prose-sm max-w-none" style="color: var(--text-primary);">
                                ${content}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            highlightCode();
            if (!state.userIsTyping) {
                scrollToBottom();
            }
        }

        function highlightCode() {
            setTimeout(() => {
                document.querySelectorAll('pre code').forEach((block) => {
                    if (typeof hljs !== 'undefined') {
                        hljs.highlightElement(block);
                    }
                });
            }, 0);
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container && !state.userIsTyping) {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================
        // UI INTERACTIONS
        // =============================
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            document.body.className = state.darkMode ? 'dark' : 'light';
            
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            
            if (state.darkMode) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                text.textContent = 'Light Mode';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
                text.textContent = 'Dark Mode';
            }
            
            saveToLocalStorage();
        }

        function openSettingsModal() {
            document.getElementById('apiKeyInput').value = state.apiKey;
            document.getElementById('modelInput').value = state.model;
            document.getElementById('systemPromptInput').value = state.systemPrompt;
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('apiKeyInput').value.trim();
            state.model = document.getElementById('modelInput').value.trim() || 'arcee-ai/trinity-large-preview:free';
            state.systemPrompt = document.getElementById('systemPromptInput').value.trim() || 'You are a helpful assistant.';
            saveToLocalStorage();
            closeSettingsModal();
        }

        function openRenameModal(chatId) {
            state.renamingChatId = chatId;
            const chat = state.chats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('renameInput').value = chat.name;
                document.getElementById('renameModal').classList.add('active');
            }
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.remove('active');
            state.renamingChatId = null;
        }

        function saveRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (state.renamingChatId && newName) {
                renameChat(state.renamingChatId, newName);
            }
            closeRenameModal();
        }

        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Make functions globally accessible
        window.switchChat = switchChat;
        window.deleteChat = deleteChat;
        window.openRenameModal = openRenameModal;
        window.removeImage = removeImage;

        // =============================
        // EVENT LISTENERS
        // =============================
        function initEventListeners() {
            // New Chat
            document.getElementById('newChatBtn').addEventListener('click', createNewChat);

            // Image Upload
            document.getElementById('imageUpload').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageUpload(e.target.files);
                    e.target.value = ''; // Reset input
                }
            });

            // Send Message
            document.getElementById('sendBtn').addEventListener('click', () => {
                const input = document.getElementById('messageInput');
                const content = input.value;
                sendMessage(content);
                input.value = '';
                input.style.height = 'auto';
            });

            // Enter to send
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('sendBtn').click();
                }
            });

            // Track when user is typing
            document.getElementById('messageInput').addEventListener('input', (e) => {
                state.userIsTyping = true;
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 200) + 'px';
                
                // Reset typing flag after 1 second of no input
                clearTimeout(window.typingTimeout);
                window.typingTimeout = setTimeout(() => {
                    state.userIsTyping = false;
                }, 1000);
            });

            document.getElementById('messageInput').addEventListener('focus', () => {
                state.userIsTyping = true;
            });

            document.getElementById('messageInput').addEventListener('blur', () => {
                setTimeout(() => {
                    state.userIsTyping = false;
                }, 500);
            });

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('cancelSettingsBtn').addEventListener('click', closeSettingsModal);

            // Rename
            document.getElementById('saveRenameBtn').addEventListener('click', saveRename);
            document.getElementById('cancelRenameBtn').addEventListener('click', closeRenameModal);

            // Dark Mode
            document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

            // Mobile Menu
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeMobileSidebar);

            // Close modals on outside click
            document.getElementById('settingsModal').addEventListener('click', (e) => {
                if (e.target.id === 'settingsModal') closeSettingsModal();
            });
            document.getElementById('renameModal').addEventListener('click', (e) => {
                if (e.target.id === 'renameModal') closeRenameModal();
            });
        }

        // =============================
        // INITIALIZATION
        // =============================
        function init() {
            loadFromLocalStorage();
            
            // Apply dark mode
            document.body.className = state.darkMode ? 'dark' : 'light';
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (state.darkMode) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                text.textContent = 'Light Mode';
            }

            // Create initial chat if none exists
            if (state.chats.length === 0) {
                createNewChat();
            } else {
                state.currentChatId = state.chats[0].id;
            }

            initEventListeners();
            renderChatList();
            renderMessages();

            // Hide loading, show app
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
                </html>
